@page
@using Net.Leksi.Pocota.Client
@using Net.Leksi.Pocota.Tool
@using Net.Leksi.Pocota.Tool.Pages
@using Net.Leksi.Pocota.Tool.Pages.Client.CS
@model ModelModel
@{
}
@Html.Partial("Header", Model)
public class @Model.ClassName@(Model.Inheritances.Count > 0 ? Html.Raw($": {string.Join(", ", Model.Inheritances)}") : string.Empty)
{
@foreach (PropertyModel prop in Model.Properties)
{
    <text>    private class @prop.Name@{}Property(IPocotaEntity entity, string name, Type type): EntityProperty(entity, name, type)
    {
        public override object? Value 
        {
            get 
            {
                if(Access is AccessKind.NotSet || Access is AccessKind.Forbidden)
                {
                    return default;
                }
                return _value ?? default;
            }
            set 
            {
                if (!IsReadonly)
                {
                    if(value is @Html.Raw(prop.TypeName) val && val != ((@Model.ClassName)Entity).@{}@prop.Name)
                    {
                        _value = val;
                        NotifyPropertyChanged();
                    }
                    else if(value == default && _value != default)
                    {
                        _value = default;
                        NotifyPropertyChanged();
                    }
                }
            }
        }
        public override bool IsNullable => @(prop.IsNullable ? "true" : "false");
    }
</text>
}
    private class @Model.ClassName@{}PocotaEntity: PocotaEntity, I@{}@Model.ClassName@{}PocotaEntity
    {
@foreach (PropertyModel prop in Model.Properties)
{
    <text>        public @nameof(EntityProperty) @prop.Name { get; private init;}
</text>
}
        internal @Model.ClassName@{}PocotaEntity(ulong pocotaId, PocotaContext context): base(pocotaId, context) 
        {
@foreach (PropertyModel prop in Model.Properties)
{
    <text>            @prop.Name = new @prop.Name@{}Property@{}(this, s_@{}@prop.Name, typeof(@Html.Raw(prop.TypeName)));
</text>
}
        }
        protected override IEnumerable<EntityProperty> GetProperties()
        {
@foreach (PropertyModel prop in Model.Properties)
{
    <text>            yield return @prop.Name;
</text>
}
        }
    }
@foreach (PropertyModel prop in Model.Properties)
{
    <text>    private const string s_@{}@prop.Name = "@prop.Name";
</text>
}
    private readonly @Model.ClassName@{}PocotaEntity _entity;
@foreach (PropertyModel prop in Model.Properties)
{
    <text>    public @Html.Raw(prop.TypeName)@(prop.IsNullable ? "?" : string.Empty) @prop.Name 
    { 
        get => (@Html.Raw(prop.TypeName)@(prop.IsNullable ? "?" : string.Empty))_entity.@prop.Name@{}.Value@(prop.IsNullable ? string.Empty : "!"); 
        set => _entity.@prop.Name@{}.Value = value; 
    }
</text>
}
    IPocotaEntity IEntityOwner.Entity => _entity;
    internal @Model.ClassName@{}(ulong pocotaId, PocotaContext context)
    {
        _entity = new @Model.ClassName@{}PocotaEntity(pocotaId, context);
    }
}
